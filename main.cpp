#include <iostream>
#include <SciFilter.h>

#define TEST(n, r)                                       \
    std::cout << "Test \"" << n << "\" => ";             \
    if (r)                                               \
        std::cout << "\033[42mPASS\033[0m" << std::endl; \
    else                                                 \
        std::cout << "\033[41mFAIL\033[0m" << std::endl;

static bool test0();
static bool test1();

int main(int, char **)
{
    TEST("filtfilt", test0());
    TEST("sosfiltfilt", test1());
}

static bool test0()
{
    VectorXd a(9), b(9), data(30), exp(30);
    a << 1., -3.93657553, 8.2603943, -11.2174259, 10.78363101,
        -7.39144283, 3.57650493, -1.11504665, 0.18737949;
    b << 0.00482434, 0., -0.01929737, 0., 0.02894606, 0.,
        -0.01929737, 0., 0.00482434;
    data << 0.6946206, 0.72065928, 0.71175556, 0.3165333, 0.56357013,
        0.57616846, 0.3945364, 0.95319502, 0.00880446, 0.7289753,
        0.0959869, 0.87426247, 0.28919631, 0.20801535, 0.66681132,
        0.45294633, 0.31652167, 0.41018225, 0.25336426, 0.55678081,
        0.07227884, 0.13323194, 0.24559928, 0.99696976, 0.47162671,
        0.93892957, 0.03232417, 0.15617559, 0.00110923, 0.07243705;
    exp << 0.00303592, 0.01212874, -0.01941804, -0.06413325, -0.05837945,
        0.01112898, 0.08101179, 0.08182186, 0.01631998, -0.04886925,
        -0.05996403, -0.02626079, 0.00440238, 0.00320082, -0.01293557,
        -0.0040924, 0.04532604, 0.09602807, 0.07731355, -0.03749039,
        -0.17303844, -0.19505246, -0.0418655, 0.18585137, 0.29161136,
        0.16175058, -0.11601363, -0.31616715, -0.26804625, -0.00486653;
    return SciFilter::filtfilt(b, a, data).isApprox(exp, 1e-6);
}

static bool test1()
{
    MatrixXd sos(4, 6);
    sos << 2.13138727e-04, -4.26277454e-04, 2.13138727e-04, 1.00000000e+00, 1.59908181e+00, 7.57867157e-01,
        1.00000000e+00, -2.00000000e+00, 1.00000000e+00, 1.00000000e+00, 1.71742882e+00, 8.10236696e-01,
        1.00000000e+00, 2.00000000e+00, 1.00000000e+00, 1.00000000e+00, 1.63790142e+00, 8.78904341e-01,
        1.00000000e+00, 2.00000000e+00, 1.00000000e+00, 1.00000000e+00, 1.86376749e+00, 9.32707241e-01;
    VectorXd data(30), exp(30);
    data << 0.6946206, 0.72065928, 0.71175556, 0.3165333, 0.56357013,
        0.57616846, 0.3945364, 0.95319502, 0.00880446, 0.7289753,
        0.0959869, 0.87426247, 0.28919631, 0.20801535, 0.66681132,
        0.45294633, 0.31652167, 0.41018225, 0.25336426, 0.55678081,
        0.07227884, 0.13323194, 0.24559928, 0.99696976, 0.47162671,
        0.93892957, 0.03232417, 0.15617559, 0.00110923, 0.07243705;
    exp << 0.00445621, -0.04264125, 0.06853613, -0.07264761, 0.05113309,
        -0.00691638, -0.0508848, 0.10907001, -0.15347717, 0.17234712,
        -0.15912316, 0.11403601, -0.04413375, -0.03820585, 0.11789458,
        -0.18026087, 0.21398486, -0.21323148, 0.17858917, -0.11670304,
        0.03876685, 0.04174987, -0.11164863, 0.16032457, -0.18145315,
        0.17378224, -0.14095663, 0.09048522, -0.03210869, -0.02408609;
    return SciFilter::sosfiltfilt(sos, data).isApprox(exp, 1e-6);
}
